1
00:00:00,000 --> 00:00:04,110
那我們來看一下第三個所謂防火牆的技術

2
00:00:04,110 --> 00:00:05,810
我們叫Stateful Filter

3
00:00:05,810 --> 00:00:07,550
那Stateful Filter就是說

4
00:00:07,550 --> 00:00:10,080
它會建一個所謂的State table

5
00:00:10,080 --> 00:00:15,710
就它為了追蹤這個每一個封包可能屬於哪一個連線

6
00:00:15,710 --> 00:00:17,250
所以它會建一個State table

7
00:00:17,250 --> 00:00:20,980
這個State table就要maintain所有connection context

8
00:00:20,980 --> 00:00:26,180
就是說它會注意到目前連線建立的狀態的意思

9
00:00:26,180 --> 00:00:30,710
那這裡所謂的Stateful就是它會記錄過去的封包

10
00:00:30,710 --> 00:00:35,250
也就是說Stateful的意思就跟State有關

11
00:00:35,250 --> 00:00:40,850
也就是說這個封包本身它是屬於在哪個State是有關係的

12
00:00:40,850 --> 00:00:45,410
譬如說我們說TCP建連線是3-way handshaking

13
00:00:45,410 --> 00:00:49,880
會有一個SYN的封包過去 然後會有SYN-ACK 再ACK

14
00:00:49,880 --> 00:00:53,380
那SYN、SYN-ACK、ACK

15
00:00:53,380 --> 00:00:55,380
那如果說SYN沒有過來

16
00:00:55,380 --> 00:00:58,010
那ACK跑進來、SYN-ACK跑進來

17
00:00:58,010 --> 00:01:02,250
就代表說這個封包應該是錯誤的 因為SYN沒有經過

18
00:01:02,250 --> 00:01:06,910
也就是說一個封包跟過去的封包有關係的話

19
00:01:06,910 --> 00:01:09,050
一般我們叫做所謂的stateful

20
00:01:09,050 --> 00:01:14,510
那Stateful Filter就是說它會記錄每一個TCP連線的狀態

21
00:01:14,510 --> 00:01:17,810
譬如說這個連線是SYN過去了

22
00:01:17,810 --> 00:01:21,910
另外一個連線可能是SYN過去了 SYN-ACK也回來了

23
00:01:21,910 --> 00:01:25,380
或者說已經建好了 就SYN、ACK、ACK

24
00:01:25,380 --> 00:01:29,810
就它每一個連線它在建連線的狀態是

25
00:01:29,810 --> 00:01:32,610
譬如說第一個封包、第二個封包

26
00:01:32,610 --> 00:01:35,410
還是已經建完了 還是沒有連線

27
00:01:35,410 --> 00:01:37,110
因為沒有連線的封包

28
00:01:37,110 --> 00:01:41,610
如果說有其他這種連線沒有建的封包也跑進來

29
00:01:41,610 --> 00:01:44,380
這種封包我們可能就要把它丟掉的意思

30
00:01:44,380 --> 00:01:49,480
那這個Stateful Filter一般都在Transport Layer

31
00:01:49,480 --> 00:01:51,380
第四層這邊來做檢查

32
00:01:51,380 --> 00:01:53,910
因為它建那個TCP連線

33
00:01:53,910 --> 00:01:58,710
所以基本上是要靠這個所謂的第四層的這個技術

34
00:01:58,710 --> 00:02:01,310
那我們說 舉個例子

35
00:02:01,310 --> 00:02:03,680
譬如說在這個Stateful Filter裡面

36
00:02:03,680 --> 00:02:07,250
每一個TCP的連線它都會有一個這個

37
00:02:07,250 --> 00:02:11,110
SYN的這個bit被設起來

38
00:02:11,110 --> 00:02:13,910
就SYN bit代表說它要建連線

39
00:02:13,910 --> 00:02:18,380
那我們說 假設有一個封包看到一個SYN

40
00:02:18,380 --> 00:02:22,680
封包穿過這個防火牆 假設我們把它建起來

41
00:02:22,680 --> 00:02:29,280
可是如果說經過 譬如說60秒

42
00:02:29,280 --> 00:02:33,050
那個SYN-ACK 就第二個封包沒有回來

43
00:02:33,050 --> 00:02:37,680
就等於說它有一個SYN的封包過去了

44
00:02:37,680 --> 00:02:41,310
可是這個SYN-ACK它沒有出現

45
00:02:41,310 --> 00:02:43,180
就是第二個封包沒有回來

46
00:02:43,180 --> 00:02:46,110
過一段時間之後 那我們就把它清掉

47
00:02:46,110 --> 00:02:48,750
因為我們不能讓它有殘留在這個地方的意思

48
00:02:48,750 --> 00:02:52,480
那這個也是等於說我們會做這樣的紀錄

49
00:02:52,480 --> 00:02:55,210
我們說 那譬如說這個例子就是說

50
00:02:55,210 --> 00:03:02,050
這個140.114.1.17 到140.113

51
00:03:02,050 --> 00:03:05,010
source port、destination port

52
00:03:05,010 --> 00:03:07,310
這裡destination port都是80

53
00:03:07,310 --> 00:03:13,080
代表說它們都是 譬如說TCP要去用HTTP

54
00:03:13,080 --> 00:03:17,350
我們說這個 如果說這個Rule Table裡面

55
00:03:17,350 --> 00:03:20,050
等一下我們會看 Rule Table裡面說

56
00:03:20,050 --> 00:03:25,210
它的Stateful table要去做檢查

57
00:03:25,210 --> 00:03:28,080
也就我們的Rule Table裡面會有一個欄位說

58
00:03:28,080 --> 00:03:32,010
那這個封包如果符合這個Rule

59
00:03:32,010 --> 00:03:35,480
那要不要進一步檢查它的Stateful

60
00:03:35,480 --> 00:03:40,210
要不要進一步檢查 如果是要進一步檢查的話

61
00:03:40,210 --> 00:03:44,750
那就去檢查說它的連線是不是已經建立起來

62
00:03:44,750 --> 00:03:47,110
那如果沒有建立起來代表說

63
00:03:47,110 --> 00:03:51,750
這個封包是屬於沒有連線的封包

64
00:03:51,750 --> 00:03:54,610
那這個封包一般就會把它丟棄的意思

65
00:03:54,610 --> 00:03:58,280
我們來看一個例子 譬如說我們這邊是我們的Rule

66
00:03:58,280 --> 00:04:03,980
一樣 那這個就是所謂的檢查 connection table

67
00:04:03,980 --> 00:04:06,410
就這個地方是告訴我們說要不要去檢查

68
00:04:06,410 --> 00:04:08,580
剛剛提到的stateful table

69
00:04:08,580 --> 00:04:12,910
這裡說我們說有一個封包它從外面進來

70
00:04:12,910 --> 00:04:15,750
它的source IP譬如說是這個

71
00:04:15,750 --> 00:04:21,810
140.113.90.123 然後source port是80

72
00:04:21,810 --> 00:04:24,780
然後他的destination是這個IP

73
00:04:24,780 --> 00:04:28,750
destination port是5000 然後ACK=1

74
00:04:28,750 --> 00:04:32,310
當這個封包進來的時候

75
00:04:32,310 --> 00:04:36,580
我們就去這個所謂的Rule Table到底它是符合哪一個

76
00:04:36,580 --> 00:04:40,510
那我們發現說這個封包本身

77
00:04:40,510 --> 00:04:44,450
它所'符合的條件是在這一個 第二個Rule

78
00:04:44,450 --> 00:04:45,950
為什麼我們來看一下 我們說

79
00:04:45,950 --> 00:04:50,180
這個Rule是說從這個網路的外面

80
00:04:50,180 --> 00:04:53,750
就是140.114這個網路的外部

81
00:04:53,750 --> 00:04:57,780
那這個是140.113 所以這是外部的

82
00:04:57,780 --> 00:05:02,610
然後到內部的 這跟它的Destination是140.114

83
00:05:02,610 --> 00:05:05,210
這個是140.114 也就是說

84
00:05:05,210 --> 00:05:11,080
這個封包是從這個網路的外部到這個網路的內部

85
00:05:11,080 --> 00:05:13,650
然後他是TCP的protocol

86
00:05:13,650 --> 00:05:15,280
這是TCP的protocol

87
00:05:15,280 --> 00:05:18,810
source port是80

88
00:05:18,810 --> 00:05:20,450
然後它有帶一個ACK

89
00:05:20,450 --> 00:05:21,810
它有帶一個ACK

90
00:05:21,810 --> 00:05:27,650
也就是說這個封包是符合這個Rule的

91
00:05:27,650 --> 00:05:30,010
但是它又多了一個說

92
00:05:30,010 --> 00:05:35,910
但是要去檢查說它的連線是不是有建立起來

93
00:05:35,910 --> 00:05:38,210
連線是不是有建立起來

94
00:05:38,210 --> 00:05:39,650
那它就要去檢查

95
00:05:39,650 --> 00:05:44,610
如果說這個connection本身已經在connection table

96
00:05:44,610 --> 00:05:46,850
就是說connection table裡面會記錄著說

97
00:05:46,850 --> 00:05:49,380
目前已經建立的連線

98
00:05:49,380 --> 00:05:54,010
那這個規則就是說當你的封包符合某一個Rule

99
00:05:54,010 --> 00:05:56,210
但是這個Rule裡面又說

100
00:05:56,210 --> 00:05:59,010
要去檢查這個封包是不是已經建立

101
00:05:59,010 --> 00:06:00,610
那我們就會去檢查

102
00:06:00,610 --> 00:06:04,310
如果這個連線已經建立起來 這個封包就讓它過

103
00:06:04,310 --> 00:06:08,510
那如果這個連線沒有被建立起來 這個封包就不可以過

104
00:06:08,510 --> 00:06:12,450
就是說它會進一步的去檢查說

105
00:06:12,450 --> 00:06:19,550
一個封包它到底是不是屬於一個已經建好的連線

106
00:06:19,550 --> 00:06:21,510
等於說多一個這個stateful的檢查

107
00:06:21,510 --> 00:06:25,610
那沒有建好的連線 突然跑出一個封包來

108
00:06:25,610 --> 00:06:31,310
那有可能就是假造的 偽造的IP 或者攻擊性的封包

109
00:06:31,310 --> 00:06:33,580
我們就不讓它通過這樣子

110
00:06:33,580 --> 00:06:36,350
所以這個stateful的這個機制

111
00:06:36,350 --> 00:06:42,480
等於說它是非常的對於這個連線的控管就非常的嚴謹

112
00:06:42,480 --> 00:06:44,780
那也可以做到比較好的這個保護

113
00:06:44,780 --> 00:06:46,780

